{% extends "base.html" %}

{% block title %}File Management - GRG Ignite{% endblock %}

{% block content %}
<div class="container">
    <div class="dashboard-header">
        <h1>üìÅ File Management</h1>
        <div style="display: flex; gap: 1rem;">
            {% if session.user_type == 'admin' %}
            <button onclick="showModal('uploadModal')" class="btn btn-primary">
                <i class="icon">üì§</i> Upload File
            </button>
            {% elif session.user_type == 'student' %}
            <button onclick="showModal('uploadModal')" class="btn btn-primary">
                <i class="icon">üì§</i> Upload Assignment
            </button>
            {% elif session.user_type == 'faculty' %}
            <button onclick="showModal('uploadModal')" class="btn btn-primary">
                <i class="icon">üì§</i> Upload Resource
            </button>
            {% endif %}
            <button onclick="refreshFiles()" class="btn btn-glass">
                <i class="icon">üîÑ</i> Refresh
            </button>
        </div>
    </div>

    <!-- File Statistics -->
    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
        <div class="stat-card">
            <h3 id="totalFiles">{{ files|length }}</h3>
            <p>Total Files</p>
        </div>
        <div class="stat-card">
            <h3 id="myFiles">
                {% set my_files = files|selectattr('uploaded_by', 'equalto', session.user_id)|list %}
                {{ my_files|length }}
            </h3>
            <p>My Uploads</p>
        </div>
        <div class="stat-card">
            <h3 id="adminFiles">
                {% set admin_files = files|selectattr('uploader_type', 'equalto', 'admin')|list %}
                {{ admin_files|length }}
            </h3>
            <p>From Admin</p>
        </div>
        <div class="stat-card">
            <h3 id="totalSize">
                {% set total_size = files|sum(attribute='file_size') %}
                {{ "%.2f"|format(total_size / 1024 / 1024) }} MB
            </h3>
            <p>Total Size</p>
        </div>
    </div>

    <!-- File Filters -->
    <div class="card">
        <h2 style="color: var(--text-white); margin-bottom: 1rem;">üîç Filter Files</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <input type="text" id="searchFiles" placeholder="üîç Search files..." style="padding: 0.75rem; border-radius: 12px; border: 2px solid var(--border-light); background: var(--glass-bg); color: var(--text-white);">
            
            <select id="filterType" style="padding: 0.75rem; border-radius: 12px; border: 2px solid var(--border-light); background: var(--glass-bg); color: var(--text-white);">
                <option value="all">All File Types</option>
                <option value="pdf">PDF Documents</option>
                <option value="doc">Word Documents</option>
                <option value="image">Images</option>
                <option value="other">Other</option>
            </select>
            
            <select id="filterUploader" style="padding: 0.75rem; border-radius: 12px; border: 2px solid var(--border-light); background: var(--glass-bg); color: var(--text-white);">
                <option value="all">All Uploaders</option>
                <option value="admin">Admin Files</option>
                <option value="student">Student Files</option>
                <option value="faculty">Faculty Files</option>
                <option value="mine">My Files</option>
            </select>
            
            <button onclick="clearFilters()" class="btn btn-outline">
                <i class="icon">üóëÔ∏è</i> Clear Filters
            </button>
        </div>
    </div>

    <!-- Files List -->
    <div class="card">
        <h2 style="color: var(--text-white); margin-bottom: 2rem;">
            üìÑ Files 
            <span id="fileCount" style="font-size: 1rem; opacity: 0.8;">({{ files|length }} files)</span>
        </h2>
        
        {% if files %}
        <div id="filesList" class="file-list">
            {% for file in files %}
            <div class="file-item" data-filename="{{ file.original_filename|lower }}" data-type="{{ file.file_type|lower }}" data-uploader="{{ file.uploader_type }}" data-uploaded-by="{{ file.uploaded_by }}">
                <div class="file-info">
                    <div class="file-name">
                        {% if file.file_type and 'pdf' in file.file_type %}üìÑ
                        {% elif file.file_type and ('doc' in file.file_type or 'word' in file.file_type) %}üìù
                        {% elif file.file_type and ('image' in file.file_type or 'jpeg' in file.file_type or 'png' in file.file_type) %}üñºÔ∏è
                        {% elif file.file_type and ('zip' in file.file_type or 'archive' in file.file_type) %}üì¶
                        {% else %}üìé
                        {% endif %}
                        {{ file.original_filename }}
                    </div>
                    <div class="file-meta">
                        Size: {{ "%.2f"|format(file.file_size / 1024 / 1024) }} MB | 
                        Uploaded: {{ file.upload_date.split('T')[0] if file.upload_date else 'Unknown' }} | 
                        By: {{ file.uploaded_by_name }} 
                        {% if file.uploader_type %}
                        <span class="status-badge" style="background: 
                        {% if file.uploader_type == 'admin' %}var(--primary-gradient)
                        {% elif file.uploader_type == 'student' %}var(--info-gradient)
                        {% elif file.uploader_type == 'faculty' %}var(--success-gradient)
                        {% endif %}; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 0.5rem;">
                            {{ file.uploader_type.upper() }}
                        </span>
                        {% endif %}
                    </div>
                    {% if file.description %}
                    <div style="margin-top: 0.5rem; color: var(--text-light); font-size: 0.9rem;">
                        {{ file.description }}
                    </div>
                    {% endif %}
                </div>
                <div class="file-actions">
                    <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn btn-small btn-primary">
                        <i class="icon">‚¨áÔ∏è</i> Download
                    </a>
                    {% if session.user_type == 'admin' or file.uploaded_by == session.user_id %}
                    <button onclick="showFileDetails({{ file.id }}, '{{ file.original_filename }}', '{{ file.description or '' }}', '{{ file.uploaded_by_name }}', '{{ file.upload_date }}')" class="btn btn-small btn-glass">
                        <i class="icon">üëÅÔ∏è</i> Details
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 3rem; color: var(--text-light);">
            <i class="icon" style="font-size: 4rem; margin-bottom: 1rem;">üìÅ</i>
            <h3 style="color: var(--text-white); margin-bottom: 1rem;">No Files Yet</h3>
            <p>No files have been uploaded yet. Be the first to share a file!</p>
            <div style="margin-top: 2rem;">
                <button onclick="showModal('uploadModal')" class="btn btn-primary">
                    <i class="icon">üì§</i> Upload First File
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Upload File Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('uploadModal')">&times;</span>
        <h2 style="color: var(--text-white); margin-bottom: 2rem;">
            üì§ Upload 
            {% if session.user_type == 'admin' %}File
            {% elif session.user_type == 'student' %}Assignment
            {% elif session.user_type == 'faculty' %}Resource
            {% endif %}
        </h2>
        
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>üìÅ Select File:</label>
                <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" name="file" style="display: none;" onchange="updateFileName(this)" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.zip,.txt,.jpg,.jpeg,.png,.gif">
                    <div id="fileUploadText">
                        Click here or drag and drop your file<br>
                        <small style="opacity: 0.8;">Supported: PDF, DOC, PPT, XLS, ZIP, Images (Max: 50MB)</small>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="description">üìù Description:</label>
                <textarea id="description" name="description" placeholder="Describe the file content and purpose" required></textarea>
            </div>
            
            {% if session.user_type == 'admin' %}
            <div class="form-group">
                <label for="uploadedFor">üë• Share with:</label>
                <select id="uploadedFor" name="uploaded_for">
                    <option value="all">All Users</option>
                    <option value="student">Students Only</option>
                    <option value="faculty">Faculty Only</option>
                </select>
            </div>
            {% endif %}
            
            <div id="uploadProgress" style="display: none; margin-bottom: 1rem;">
                <div class="progress-bar" style="background: rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden;">
                    <div id="progressFill" class="progress" style="background: var(--primary-gradient); color: white; text-align: center; line-height: 30px; height: 30px; width: 0%; transition: width 0.3s;">0%</div>
                </div>
                <p style="text-align: center; margin-top: 0.5rem; color: var(--text-light);">
                    Uploading... Please don't close this window.
                </p>
            </div>
            
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <i class="icon">üöÄ</i> Upload File
            </button>
        </form>
    </div>
</div>

<!-- File Details Modal -->
<div id="fileDetailsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('fileDetailsModal')">&times;</span>
        <div id="fileDetailsContent">
            <!-- File details will be loaded here -->
        </div>
    </div>
</div>

<style>
/* Additional styles for file management */
.file-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.3s ease;
}

.file-item:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--primary-color);
}

.file-info {
    flex: 1;
}

.file-name {
    font-weight: 600;
    color: var(--text-white);
    margin-bottom: 0.5rem;
}

.file-meta {
    font-size: 0.85rem;
    color: var(--text-light);
}

.file-actions {
    display: flex;
    gap: 0.5rem;
}

.file-upload-area {
    border: 2px dashed var(--border-light);
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.02);
}

.file-upload-area:hover {
    border-color: var(--primary-color);
    background: rgba(255, 255, 255, 0.05);
}

.file-upload-area.drag-over {
    border-color: var(--success-color);
    background: rgba(34, 197, 94, 0.1);
}

.loading {
    opacity: 0.6;
    pointer-events: none;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    transform: translate(-50%, -50%);
}
</style>

<script>
// Utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showNotification(message, type = 'info', duration = 3000) {
    // Remove existing notifications
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    
    // Set background color based on type
    const colors = {
        success: '#22c55e',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#3b82f6'
    };
    notification.style.background = colors[type] || colors.info;
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Animate out and remove
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, duration);
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// Setup file filtering and search
document.addEventListener('DOMContentLoaded', function() {
    setupFileFilters();
    setupFileUpload();
    setupModalHandlers();
});

function setupModalHandlers() {
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });
    });
}

function setupFileFilters() {
    const searchInput = document.getElementById('searchFiles');
    const typeFilter = document.getElementById('filterType');
    const uploaderFilter = document.getElementById('filterUploader');
    
    function filterFiles() {
        const searchTerm = searchInput.value.toLowerCase();
        const typeFilter_value = typeFilter.value;
        const uploaderFilter_value = uploaderFilter.value;
        const fileItems = document.querySelectorAll('.file-item');
        
        let visibleCount = 0;
        
        fileItems.forEach(item => {
            const filename = item.dataset.filename;
            const filetype = item.dataset.type || '';
            const uploader = item.dataset.uploader;
            const uploadedBy = item.dataset.uploadedBy;
            
            let showItem = true;
            
            // Search filter
            if (searchTerm && !filename.includes(searchTerm)) {
                showItem = false;
            }
            
            // Type filter
            if (typeFilter_value !== 'all') {
                if (typeFilter_value === 'pdf' && !filetype.includes('pdf')) showItem = false;
                if (typeFilter_value === 'doc' && !filetype.includes('doc') && !filetype.includes('word')) showItem = false;
                if (typeFilter_value === 'image' && !filetype.includes('image') && !filetype.includes('jpeg') && !filetype.includes('png')) showItem = false;
                if (typeFilter_value === 'other' && (filetype.includes('pdf') || filetype.includes('doc') || filetype.includes('word') || filetype.includes('image'))) showItem = false;
            }
            
            // Uploader filter
            if (uploaderFilter_value !== 'all') {
                if (uploaderFilter_value === 'admin' && uploader !== 'admin') showItem = false;
                if (uploaderFilter_value === 'student' && uploader !== 'student') showItem = false;
                if (uploaderFilter_value === 'faculty' && uploader !== 'faculty') showItem = false;
                if (uploaderFilter_value === 'mine' && uploadedBy !== '{{ session.user_id }}') showItem = false;
            }
            
            if (showItem) {
                item.style.display = 'flex';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Update file count
        document.getElementById('fileCount').textContent = `(${visibleCount} files shown)`;
    }
    
    // Add event listeners
    searchInput.addEventListener('input', debounce(filterFiles, 300));
    typeFilter.addEventListener('change', filterFiles);
    uploaderFilter.addEventListener('change', filterFiles);
}

function clearFilters() {
    document.getElementById('searchFiles').value = '';
    document.getElementById('filterType').value = 'all';
    document.getElementById('filterUploader').value = 'all';
    
    // Show all files
    const fileItems = document.querySelectorAll('.file-item');
    fileItems.forEach(item => {
        item.style.display = 'flex';
    });
    
    // Reset file count
    document.getElementById('fileCount').textContent = `({{ files|length }} files)`;
    
    showNotification('Filters cleared', 'info', 2000);
}

function refreshFiles() {
    // Add loading animation
    const filesList = document.getElementById('filesList');
    if (filesList) {
        filesList.classList.add('loading');
    }
    
    showNotification('Refreshing files...', 'info', 1000);
    
    // Reload the page after a short delay
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

function showFileDetails(fileId, filename, description, uploadedBy, uploadDate) {
    const modal = document.getElementById('fileDetailsModal');
    const content = document.getElementById('fileDetailsContent');
    
    const formattedDate = new Date(uploadDate).toLocaleString();
    
    content.innerHTML = `
        <h2 style="color: var(--text-white); margin-bottom: 1rem;">üìÑ ${filename}</h2>
        <div style="display: grid; gap: 1rem; margin-bottom: 2rem;">
            <div>
                <strong style="color: var(--text-white);">üìù Description:</strong>
                <p style="color: var(--text-light); margin-top: 0.5rem;">${description || 'No description provided'}</p>
            </div>
            <div>
                <strong style="color: var(--text-white);">üë§ Uploaded by:</strong>
                <p style="color: var(--text-light); margin-top: 0.5rem;">${uploadedBy}</p>
            </div>
            <div>
                <strong style="color: var(--text-white);">üìÖ Upload Date:</strong>
                <p style="color: var(--text-light); margin-top: 0.5rem;">${formattedDate}</p>
            </div>
        </div>
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <a href="/download/${fileId}" class="btn btn-primary">
                <i class="icon">‚¨áÔ∏è</i> Download File
            </a>
            {% if session.user_type == 'admin' %}
            <button class="btn btn-danger" onclick="deleteFile(${fileId})">
                <i class="icon">üóëÔ∏è</i> Delete File
            </button>
            {% endif %}
            <button class="btn btn-outline" onclick="closeModal('fileDetailsModal')">
                <i class="icon">‚ùå</i> Close
            </button>
        </div>
    `;
    
    showModal('fileDetailsModal');
}

function deleteFile(fileId) {
    if (confirm('Are you sure you want to delete this file? This action cannot be undone.')) {
        fetch(`/delete_file/${fileId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('File deleted successfully!', 'success');
                closeModal('fileDetailsModal');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification(data.error || 'Failed to delete file', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Network error occurred', 'error');
        });
    }
}

function updateFileName(input) {
    const fileUploadText = document.getElementById('fileUploadText');
    if (input.files && input.files[0]) {
        const file = input.files[0];
        const fileName = file.name;
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        
        // Check file size
        if (file.size > 50 * 1024 * 1024) { // 50MB
            showNotification('File size must be less than 50MB', 'error');
            input.value = '';
            fileUploadText.innerHTML = `
                Click here or drag and drop your file<br>
                <small style="opacity: 0.8;">Supported: PDF, DOC, PPT, XLS, ZIP, Images (Max: 50MB)</small>
            `;
            return;
        }
        
        fileUploadText.innerHTML = `
            <strong>üìÑ ${fileName}</strong><br>
            <small>Size: ${fileSize} MB | Ready to upload</small>
        `;
    }
}

function setupFileUpload() {
    const form = document.getElementById('uploadForm');
    const progressDiv = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('fileInput');
        const description = document.getElementById('description').value.trim();
        
        if (!fileInput.files || !fileInput.files[0]) {
            showNotification('Please select a file to upload', 'warning');
            return;
        }
        
        if (!description) {
            showNotification('Please provide a description for the file', 'warning');
            return;
        }
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('description', description);
        
        {% if session.user_type == 'admin' %}
        const uploadedFor = document.getElementById('uploadedFor').value;
        formData.append('uploaded_for', uploadedFor);
        {% elif session.user_type == 'student' %}
        formData.append('uploaded_for', 'admin'); // Students upload for admin
        {% elif session.user_type == 'faculty' %}
        formData.append('uploaded_for', 'student'); // Faculty uploads for students
        {% endif %}
        
        // Show progress bar
        progressDiv.style.display = 'block';
        progressFill.style.width = '0%';
        progressFill.textContent = '0%';
        
        // Disable form
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="icon">‚è≥</i> Uploading...';
        
        // Upload file with fetch API (improved error handling)
        fetch('/upload_file', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                
                showNotification('File uploaded successfully!', 'success');
                closeModal('uploadModal');
                
                // Reset form
                form.reset();
                document.getElementById('fileUploadText').innerHTML = `
                    Click here or drag and drop your file<br>
                    <small style="opacity: 0.8;">Supported: PDF, DOC, PPT, XLS, ZIP, Images (Max: 50MB)</small>
                `;
                
                // Reload page to show new file
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error(data.error || 'Upload failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification(error.message || 'Upload failed', 'error');
        })
        .finally(() => {
            // Re-enable form
            progressDiv.style.display = 'none';
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="icon">üöÄ</i> Upload File';
        });
    });
}

// Drag and drop functionality for file upload
document.addEventListener('DOMContentLoaded', function() {
    const fileUploadArea = document.querySelector('.file-upload-area');
    const fileInput = document.getElementById('fileInput');
    
    if (fileUploadArea && fileInput) {
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.add('drag-over');
        });
        
        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
        });
        
        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files && files[0]) {
                fileInput.files = files;
                updateFileName(fileInput);
            }
        });
    }
});

// Auto-refresh functionality (optional)
function enableAutoRefresh() {
    setInterval(() => {
        // Check if page is visible and not in upload process
        if (!document.hidden && !document.getElementById('uploadProgress').style.display === 'block') {
            // Silently check for new files (you can implement this based on your backend)
            console.log('Checking for new files...');
        }
    }, 30000); // Check every 30 seconds
}

// Initialize auto-refresh if needed
// enableAutoRefresh();
</script>
{% endblock %}